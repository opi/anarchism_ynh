- hosts: localhost

  tasks:
    # Not proud of this part, app settings should be offered as ansible module.
    - name: Change settings folder owner
      file: 
        path: '/etc/yunohost/apps/{{ app_name }}'
        owner: admin
        mode: 0500
        recurse: yes
      notify: Restore settings folder owner
      sudo: yes

    - name: Fetch app settings
      include_vars: '/etc/yunohost/apps/{{ app_name }}/settings.yml'

    - name: Upgrade anarchism 
      apt: 
        name: anarchism
        update_cache: yes
        cache_valid_time: 600
      sudo: yes

    - name: Remove trailing slash in app path
      set_fact: 
        path: '{{ path[:-1] }}'

    - name: Put Nginx conf
      template: 
        src: ../templates/nginx_anarchism.conf.j2
        dest: '/etc/nginx/conf.d/{{ domain }}.d/{{ app_name }}.conf'
      sudo: yes
      notify: Reload nginx

    - name: Unprotect public uri
      command: 'yunohost app setting {{ app_name }} unprotected_uris -v /'
      when: is_public == "Yes"
      sudo: yes

  handlers:
    - name: Reload nginx
      service: name=nginx state=reloaded
      sudo: yes

    - name: Restore settings folder owner
      file: 
        path: '/etc/yunohost/apps/{{ app_name }}'
        owner: root
        mode: 0400
        recurse: yes
      sudo: yes